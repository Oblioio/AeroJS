/* AeroJS v0.0.1 - http://oblio.io - @oblioio - (c) 2015 Oblio */
window.Aero=window.Aero||{},Aero.utils=Aero.utils||{},Aero.JSPrograms=Aero.JSPrograms||{},Aero.registerJSProgram=function(a,b){console.log("Aero.registerJSProgram: "+a),console.log("Aero.registerJSProgram2: "+a),Aero.JSPrograms[a]=b},function(a){function b(a){for(var b in a)a.hasOwnProperty(b)&&(a[b]=null);a=null}var c=function(a,b){this.task_arr=[],this.defaultScope=a||this,this.id=b||"",this.verbose=!1};c.prototype={execute:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | execute"),this.addNext(a),this.runStep("")},addNext:function(a){if(this.verbose&&console.log("ArrayExecuter | "+this.id+" | addNext"),"function"==typeof a)this.task_arr.unshift({fn:a,vars:null});else{a.reverse();for(var b=0;b<a.length;b++)a[b]&&this.task_arr.unshift(a[b])}},tackOn:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | tackOn");for(var b=0;b<a.length;b++)this.task_arr.push(a[b]);this.runStep("")},runFunctionInScope:function(a){var b=a[0],c=a[1];a.length>2?a[2]:null;a.length>2?b[c](a[2]):b[c]()},runStep:function(a){if(this.verbose&&console.log("ArrayExecuter | "+this.id+" | runStep"),0!=this.task_arr.length){var c=this.task_arr.shift(),d=c.fn;c.scope=c.scope||this.defaultScope,c.vars=c.vars||[],"string"==typeof c.vars&&(c.vars=[c.vars]),c.vars.push(this.stepComplete.bind(this)),d.apply(c.scope,c.vars),b(c)}},stepComplete:function(b){this.verbose&&console.log("ArrayExecuter | "+this.id+" | stepComplete"),this.task_arr.length>0&&a.requestAnimationFrame(this.runStep.bind(this))},stepComplete_instant:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | stepComplete_instant"),this.task_arr.length>0&&this.runStep()},clearArrayExecuter:function(){this.verbose&&console.log("ArrayExecuter | "+this.id+" | clearArrayExecuter"),this.task_arr=[]},destroy:function(){for(var a=0;a<this.task_arr.length;a++)b(this.task_arr[a]);this.task_arr=[],this.defaultScope=null}},Aero.utils.ArrayExecuter=c}(window),function(a){var b=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState)if(200==c.status||0==c.status)try{b(c.responseText)}catch(d){console.error(d)}else console.error("Couldn't load ["+a+"] ["+c.status+"]")},c.open("GET",a,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.setRequestHeader("Content-Type","text/plain"),c.send(null)};Aero.utils.XHRLoader=b}(window),function(a){"use strict";function b(a){return[1,0,0,0,0,Math.cos(a),Math.sin(a),0,0,-Math.sin(a),Math.cos(a),0,0,0,0,1]}function c(a,c){return k(a,b(c))}function d(a){return[Math.cos(a),0,-Math.sin(a),0,0,1,0,0,Math.sin(a),0,Math.cos(a),0,0,0,0,1]}function e(a,b){return k(a,d(b))}function f(a){return[a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1]}function g(a,b){var c=n(a);return c[0]*=b,c[4]*=b,c[8]*=b,c[1]*=b,c[5]*=b,c[9]*=b,c[2]*=b,c[6]*=b,c[10]*=b,c[3]*=b,c[7]*=b,c[11]*=b,c}function h(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]}function i(a,b,c,d){return k(a,h(b,c,d))}function j(a,b,c,d){var e=a*Math.tan(.5*c),f=-e,g=f*d,h=e*d,i=2*a/(h-g),j=2*a/(e-f),k=(h+g)/(h-g),l=(e+f)/(e-f),m=-(b+a)/(b-a),n=-2*b*a/(b-a),o=[];return o[0]=i,o[4]=0,o[8]=k,o[12]=0,o[1]=0,o[5]=j,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=m,o[14]=n,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,o}function k(a,b){for(var c,d=[],e=4,f=0;e>f;f++)for(var g=0;e>g;g++){c=0;for(var h=0;e>h;h++)c+=a[g+h*e]*b[f*e+h];d.push(c)}return d}function l(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]}function m(a){var b=[],c=a[0],d=a[4],e=a[8],f=a[12],h=a[1],i=a[5],j=a[9],k=a[13],l=a[2],m=a[6],n=a[10],o=a[14],p=a[3],q=a[7],r=a[11],s=a[15];b[0]=j*o*q-k*n*q+k*m*r-i*o*r-j*m*s+i*n*s,b[4]=f*n*q-e*o*q-f*m*r+d*o*r+e*m*s-d*n*s,b[8]=e*k*q-f*j*q+f*i*r-d*k*r-e*i*s+d*j*s,b[12]=f*j*m-e*k*m-f*i*n+d*k*n+e*i*o-d*j*o,b[1]=k*n*p-j*o*p-k*l*r+h*o*r+j*l*s-h*n*s,b[5]=e*o*p-f*n*p+f*l*r-c*o*r-e*l*s+c*n*s,b[9]=f*j*p-e*k*p-f*h*r+c*k*r+e*h*s-c*j*s,b[13]=e*k*l-f*j*l+f*h*n-c*k*n-e*h*o+c*j*o,b[2]=i*o*p-k*m*p+k*l*q-h*o*q-i*l*s+h*m*s,b[6]=f*m*p-d*o*p-f*l*q+c*o*q+d*l*s-c*m*s,b[10]=d*k*p-f*i*p+f*h*q-c*k*q-d*h*s+c*i*s,b[14]=f*i*l-d*k*l-f*h*m+c*k*m+d*h*o-c*i*o,b[3]=j*m*p-i*n*p-j*l*q+h*n*q+i*l*r-h*m*r,b[7]=d*n*p-e*m*p+e*l*q-c*n*q-d*l*r+c*m*r,b[11]=e*i*p-d*j*p-e*h*q+c*j*q+d*h*r-c*i*r,b[15]=d*j*l-e*i*l+e*h*m-c*j*m-d*h*n+c*i*n;var t=c*b[0]+h*b[4]+l*b[8]+p*b[12];return 0==t?[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]:b=g(b,1/t)}function n(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]}Aero.Math=Aero.Math||{},Aero.Math.Matrix4={createRotateX:b,rotateX:c,createRotateY:d,rotateY:e,createScale:f,scale:g,createTranslation:h,translate:i,createProjection:j,multiply:k,transpose:l,inverse:m,clone:n}}(window),function(a){"use strict";function b(a){var b=[{fn:c,vars:"vShader"},{fn:c,vars:"fShader"},{fn:d},{fn:e},{fn:a}];this.arrayExecuter.execute(b)}function c(a,b){console.log("loadShader: "+this[a].path),this.scene.data.library[this[a].path]?(this[a].text=this.scene.data.library[this[a].path],b()):Aero.utils.XHRLoader(String(this[a].path).replace("~/",this.scene.dirPath),function(c){this[a].text=c,b()}.bind(this))}function d(a){console.log("createProgram");var b=this.gl,c=b.createShader(b.FRAGMENT_SHADER);if(b.shaderSource(c,this.fShader.text),b.compileShader(c),j.call(this,b,"2d-fragment-shader",c)){this.fShader.obj=c;var d=b.createShader(b.VERTEX_SHADER);if(b.shaderSource(d,this.vShader.text),b.compileShader(d),j.call(this,b,"2d-vertex-shader",d)){this.vShader.obj=d;var e=b.createProgram();b.attachShader(e,d),b.attachShader(e,c),b.linkProgram(e),b.getProgramParameter(e,b.LINK_STATUS)||console.log("Unable to initialize the shader program."),b.useProgram(e),this.program=e,b.program=e,a()}}}function e(a){var b,c,d,e,f=this.gl,g=this.settings.uniforms;this.uniforms=[],this.inputs={};for(var h in g){switch(b=g[h],c=f.getUniformLocation(this.program,h),d=b.val||null,b.type){case"f":case"1f":e=Aero.GLUploaders.uniform1f,d||(d=0);break;case"2f":e=Aero.GLUploaders.uniform2f,d||(d=[0,0]);break;case"3f":e=Aero.GLUploaders.uniform3f,d||(d=[0,0,0]);break;case"3m":e=Aero.GLUploaders.uniformMatrix3fv,d||(d=[1,0,0,0,1,0,0,0,1]);break;case"4f":e=Aero.GLUploaders.uniform4f,d||(d=[0,0,0,0]);break;case"4m":e=Aero.GLUploaders.uniformMatrix4fv,d||(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);break;case"t":e=Aero.GLUploaders.uniform1i;break;default:console.log("uniform type: "+b.type+" not yet setup"),e=!1}this.inputs[h]=d,this.uniforms.push({id:h,type:b.type,loc:c,fn:e})}this.inputs.u_resolution||(c=f.getUniformLocation(this.program,"u_resolution"),null!==c&&(this.inputs.u_resolution=[1,1],this.uniforms.push({id:"u_resolution",type:"2f",loc:c,fn:Aero.GLUploaders.uniform2f}))),a()}function f(){for(var a,b=this.gl,c=this.uniforms.length;c--;)a=this.uniforms[c],a.fn&&a.fn(b,a.loc,this.inputs[a.id])}function g(){var a=this.gl;a.useProgram(this.program),a.program=this.program,this.updateUniforms(),a.drawArrays(a[this.settings.renderMode],0,4)}function h(a,b){this.inputs.u_resolution&&2==this.inputs.u_resolution.length&&(this.inputs.u_resolution=[a,b])}function i(){var a=this.gl;a.linkProgram(this.program),a.deleteShader(this.fShader.obj),a.deleteShader(this.fShader.obj),this.fShader=null,this.vShader=null,this.program=null,this.inputs=null,this.uniforms=null,this.arrayExecuter.destroy(),this.scene=null,this.gl=null,this.arrayExecuter=null}function j(a,b,c){var d=this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS);return d||console.log("Error compiling "+b+": "+this.gl.getShaderInfoLog(c)),d}var k=function(a,b){this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.type="GLProgram",this.inRenderList=!1,this.scene=b,this.gl=this.scene.gl,this.settings={renderMode:"TRIANGLE_STRIP"};for(var c in a)this.settings[c]=a[c];this.drawToCanvas=!1,this.clearBuffer="true"==String(a.clearBuffer).toLowerCase()?!0:!1,this.vShader={path:this.settings.vertexShader},this.fShader={path:this.settings.fragmentShader}};k.prototype.init=b,k.prototype.updateUniforms=f,k.prototype.render=g,k.prototype.resize=h,k.prototype.destroy=i,Aero=Aero||{},Aero.GLProgram=k}(window),function(a){"use strict";function b(a){this.onLoadComplete=a?a:null,this.imgURL||(console.log("loadTexture ERROR: no image url"),this.onLoadComplete&&this.onLoadComplete(),this.onLoadComplete=null),console.log("loadTexture: "+this.imgURL),this.imgObj=new Image,this.imgObj.onload=c.bind(this),this.imgObj.src=this.imgURL}function c(){var a=this.scene.gl,b=this.texture;a.activeTexture(a["TEXTURE"+this.texUnit]),a.bindTexture(a.TEXTURE_2D,b),this.width=this.imgObj.width,this.height=this.imgObj.height,a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.imgObj),this.onLoadComplete&&(this.onLoadComplete(),this.onLoadComplete=null)}function d(){var a=this.scene.gl,b=this.texture;a.deleteTexture(b),this.texture=null,this.scene=null,this.settings=null,this.imgURL=null,this.texUnit=null}var e=function(a,b){var c=b.gl,d=c.createTexture();this.type="texture",this.inRenderList=!1,this.scene=b,this.settings=a,this.imgURL=a.imgURL?a.imgURL.replace("~/",this.scene.dirPath):null,this.texUnit=a.texUnit,console.log("GLTexture Init: "+this.texUnit),this.texture=d,c.activeTexture(c["TEXTURE"+this.texUnit]),c.bindTexture(c.TEXTURE_2D,d),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)};e.prototype.loadTexture=b,e.prototype.destroy=d,Aero=Aero||{},Aero.GLTexture=e}(window),function(a){"use strict";Aero=Aero||{},Aero.GLUploaders={uniform1f:function(a,b,c){a.uniform1f(b,c)},uniform2f:function(a,b,c){a.uniform2f(b,c[0],c[1])},uniform3f:function(a,b,c){a.uniform3f(b,c[0],c[1],c[2])},uniform4f:function(a,b,c){a.uniform4f(b,c[0],c[1],c[2],c[3])},uniform1i:function(a,b,c){a.uniform1i(b,c)},uniform2i:function(a,b,c){a.uniform2i(b,c)},uniform3i:function(a,b,c){a.uniform3i(b,c)},uniform4i:function(a,b,c){a.uniform3i(b,c)},uniformMatrix2fv:function(a,b,c){a.uniformMatrix2fv(b,a.FALSE,c)},uniformMatrix3fv:function(a,b,c){a.uniformMatrix3fv(b,a.FALSE,c)},uniformMatrix4fv:function(a,b,c){a.uniformMatrix4fv(b,a.FALSE,c)}}}(window),function(a){"use strict";function b(a){this.scene=a}function c(){this.gl=this.scene.gl,this.maxTextureUnits=this.scene.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.nextTexUnit=0,this.autoRender=!1,this.arrayExecuter=new Aero.utils.ArrayExecuter(this)}function d(a){var b=[{fn:f},{fn:k},{fn:o},{fn:a}];this.arrayExecuter.execute(b)}function e(a,b){console.log("setSize: "+a+", "+b),this.scene.canvas.width=a,this.scene.canvas.height=b,this.gl.viewport(0,0,Number(a),Number(b));var c=this.scene.nodes;for(var d in c)c[d].resize&&c[d].resize(a,b)}function f(a){console.log("/////////////////  createRenderList  /////////////////");var b,c,d,e,f,j,k,l,m,n,o=this.scene.data.connections,p=g(o,"dest","canvas");for(r=0;r<p.length;r++)f=h.call(this,p[r],"source"),f.drawToCanvas=!0;for(this.renderList=[];p.length;)if(b=p.shift(),k=l=!1,c=h.call(this,b,"source"),console.log("checking node: "+c.id),!c.inRenderList){for(c.inRenderList=!0,d=g(o,"source",b.source.id),m=0;m<d.length;m++)f=h.call(this,d[m],"dest"),f&&("texture"==c.type&&(f.inputs[d[m].dest["var"]]=c.texUnit),"GLProgram"==c.type&&c.dependents.push({id:f.id,destVar:d[m].dest["var"]}),"JSProgram"==c.type&&(console.log("add output to JSProgram"),c.dependents.push({obj:f,id:f.id,sourceVar:d[m].source["var"],destVar:d[m].dest["var"]})),j=i(this.renderList,f),d[m].feedback&&"true"==String(d[m].feedback).toLowerCase()||j!==!1&&(l=l!==!1?Math.min(j,l):j));for(e=g(o,"dest",b.source.id),n=0;n<e.length;n++)f=h.call(this,e[n],"source"),f&&(f.inRenderList||p.unshift(e[n]),j=i(this.renderList,f),e[n].feedback&&"true"==String(e[n].feedback).toLowerCase()||j!==!1&&(k=k!==!1?Math.max(j,k):j));if(console.log("adding: "+c.id+", highestIndex: "+l+", lowestIndex: "+k),k!==!1&&l!==!1&&k>=l)return void console.log("createRenderList: FEEDBACK LOOP! lowestIndex is greater than highestIndex");l!==!1?this.renderList.splice(l,0,c):k!==!1?this.renderList.splice(k+1,0,c):this.renderList.push(c)}for(var q="RENDER ORDER: ",r=0;r<this.renderList.length;r++)q+=this.renderList[r].id+" > ";console.log(q),a()}function g(a,b,c){for(var d=[],e=0;e<a.length;e++)a[e][b].id.toLowerCase()==String(c).toLowerCase()&&d.push(a[e]);return d}function h(a,b){var c=!1,d=!1;return(c=this.scene.nodes)?(d=c[a[b].id],d?d:(console.log('getConnectedNode: node id "'+a[b].id+'" returned no results'),!1)):(console.log("getConnectedNode: node type "+a[b].type+" returned no results"),!1)}function i(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return!1}function j(a){return new Aero.GLTexture({imgURL:a,texUnit:this.getNextTexUnit()},this.scene)}function k(a){console.log("/////////////////  createFrameBuffers  /////////////////"),this.frameBuffers=[];var b,c,d,e,f,g;if(this.scene.data.frameBuffers)for(var f in this.scene.data.frameBuffers){var h=this.scene.data.frameBuffers[f];if(h.nodes&&h.nodes.length)for(b=l.call(this,0),b.holdForever=!0,g=0;g<h.nodes.length;g++)c=this.scene.nodes[h.nodes[g]],c?c.forcedBuffer=b:console.log('Could not assign frame buffer "'+f+'" to node "'+h.nodes[g]+'" because it does not exist')}for(f=0;f<this.renderList.length;f++)if(c=this.renderList[f],"texture"!=c.type&&("JSProgram"!=c.type||c.draws)&&!c.drawToCanvas&&c.dependents&&c.dependents.length){for(c.forcedBuffer?(b=c.forcedBuffer,c.forcedBuffer=null):b=l.call(this,f),c.outputs=c.outputs||{},c.outputs.texUnit=b.texUnit,g=0;g<c.dependents.length;g++)d=this.scene.nodes[c.dependents[g].id],"GLProgram"==d.type&&(d.inputs[c.dependents[g].destVar]=b.texUnit),e=i(this.renderList,d),b.holdIndex=Math.max(e,b.holdIndex);c.outputBuffer=b.index}a()}function l(a){for(var b=0;b<this.frameBuffers.length;b++)if(!this.frameBuffers[b].holdForever&&this.frameBuffers[b].holdIndex<a)return this.frameBuffers[b];var c=m.call(this);return c.index=this.frameBuffers.length,c.holdIndex=0,this.frameBuffers.push(c),c}function m(){var a,b,c=this.gl,d=c.createRenderbuffer(),e=this.scene.canvas.width,f=this.scene.canvas.height,g=this.getNextTexUnit();return console.log("createFrameBuffer: texUnit "+g),a=c.createFramebuffer(),c.activeTexture(c["TEXTURE"+g]),c.bindFramebuffer(c.FRAMEBUFFER,a),b=c.createTexture(),c.bindTexture(c.TEXTURE_2D,b),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,e,f,0,c.RGBA,c.UNSIGNED_BYTE,null),c.bindRenderbuffer(c.RENDERBUFFER,d),c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,e,f),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,b,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,d),c.bindRenderbuffer(c.RENDERBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,null),{frameBuffer:a,texture:b,renderBuffer:d,width:e,height:f,texUnit:g}}function n(){var a=this.nextTexUnit;return a>=this.maxTextureUnits&&console.log("ERROR: TexUnit "+a+" | Only "+this.maxTextureUnits+" are supported."),this.nextTexUnit++,a}function o(a){var b=this.gl,c=new Float32Array([-1,1,0,1,-1,-1,0,0,1,1,1,1,1,-1,1,0]),d=b.createBuffer();return d?(b.bindBuffer(b.ARRAY_BUFFER,d),b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW),this.standardVertexBuffer={buffer:d,array:c,fsize:c.BYTES_PER_ELEMENT},this.usingStandardVertexBuffer=!1,void a()):(console.log("Failed to create the buffer object"),-1)}function p(){var a=this.gl;this.usingStandardVertexBuffer=!0,a.bindBuffer(a.ARRAY_BUFFER,this.standardVertexBuffer.buffer),q(a,"a_Position",this.standardVertexBuffer.fsize,2,4,0),q(a,"a_TexCoord",this.standardVertexBuffer.fsize,2,4,2)}function q(a,b,c,d,e,f){var g=a.getAttribLocation(a.program,b);return 0>g?(console.log("Failed to get the attribute storage location of "+b),!1):(a.vertexAttribPointer(g,d,a.FLOAT,!1,c*e,c*f),a.enableVertexAttribArray(g),!0)}function r(a,b){var c=this.gl;this.usingStandardVertexBuffer=!1;var d=c.createBuffer();return d?(c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,a,c.DYNAMIC_DRAW),{buffer:d,length:a.length,data:a,fsize:a.BYTES_PER_ELEMENT,attributes:b}):(console.log("Failed to create the buffer object"),-1)}function s(a){var b=this.gl;this.usingStandardVertexBuffer=!1,b.bindBuffer(b.ARRAY_BUFFER,a.buffer),a.data.length>a.length?(a.length=a.data.length,b.bufferData(b.ARRAY_BUFFER,a.data,b.DYNAMIC_DRAW)):b.bufferSubData(b.ARRAY_BUFFER,0,a.data)}function t(a){var b=this.gl;this.usingStandardVertexBuffer=!1,b.bindBuffer(b.ARRAY_BUFFER,a.buffer);for(var c=a.attributes.length;c--;)q(b,a.attributes[c].id,a.fsize,a.attributes[c].num,a.attributes[c].stride,a.attributes[c].start)}function u(){this.autoRender||(this.autoRender=!0,this.render())}function v(){this.autoRender=!1}function w(){var b,c,d=this.gl;if(this.gl){for(var e=0;e<this.renderList.length;e++)switch(b=this.renderList[e],b.type){case"GLProgram":b.drawToCanvas?d.bindFramebuffer(d.FRAMEBUFFER,null):(d.bindFramebuffer(d.FRAMEBUFFER,this.frameBuffers[b.outputBuffer].frameBuffer),b.clearBuffer&&d.clear(d.COLOR_BUFFER_BIT)),d.useProgram(b.program),d.program=b.program,this.usingStandardVertexBuffer||this.useStandardVertexBuffer(this),b.updateUniforms(),b.render();break;case"JSProgram":for(b.draws&&(b.drawToCanvas?d.bindFramebuffer(d.FRAMEBUFFER,null):(d.bindFramebuffer(d.FRAMEBUFFER,this.frameBuffers[b.outputBuffer].frameBuffer),b.clearBuffer&&d.clear(d.COLOR_BUFFER_BIT))),b.run(),c=b.dependents.length;c--;)b.dependents[c].obj.inputs[b.dependents[c].destVar]=b.outputs[b.dependents[c].sourceVar];break;case"texture":}this.autoRender&&a.requestAnimationFrame(w.bind(this))}}function x(){for(var a=this.scene.gl,b=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),c=0;b>c;++c)a.activeTexture(a.TEXTURE0+c),a.bindTexture(a.TEXTURE_2D,null),a.bindTexture(a.TEXTURE_CUBE_MAP,null);a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null);for(var d=0;d<this.frameBuffers.length;d++)a.deleteRenderbuffer(this.frameBuffers[d].renderBuffer),a.deleteFramebuffer(this.frameBuffers[d].frameBuffer),a.deleteTexture(this.frameBuffers[d].texture),this.frameBuffers[d]=null;this.arrayExecuter.destroy(),this.scene=null,this.gl=null,this.arrayExecuter=null,this.renderList=null,this.frameBuffers=null}b.prototype.init=c,b.prototype.update=d,b.prototype.setSize=e,b.prototype.start=u,b.prototype.pause=v,b.prototype.render=w,b.prototype.createTexture=j,b.prototype.getNextTexUnit=n,b.prototype.useStandardVertexBuffer=p,b.prototype.useCustomVertexBuffer=t,b.prototype.createCustomVertexBuffer=r,b.prototype.updateCustomVertexBuffer=s,b.prototype.destroy=x,Aero=Aero||{},Aero.Renderer=b}(window),function(a){"use strict";function b(a){this.scene=a,this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.dependencies=[]}function c(a,b){console.log("AERO: loadData"),"string"==typeof a?Aero.utils.XHRLoader(a,function(c){this.scene.dirPath=a.indexOf("/")>=0?a.substring(0,a.lastIndexOf("/")+1):"",this.scene.data=JSON.parse(c),b()}.bind(this)):(this.scene.dirPath="",this.scene.data=a,b())}function d(a,b){console.log("AERO: buildData");var c=[{fn:e,vars:[a.textures]},{fn:f,vars:[a.jsPrograms||a.JSPrograms]},{fn:k,vars:[a.glPrograms||a.GLPrograms]},{fn:b}];this.arrayExecuter.execute(c)}function e(a,b){console.log("/////////////////  createTextures  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createTexture,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function f(a,b){console.log("/////////////////  createJSPrograms  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createJSProgram,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function g(a){for(var b=0;b<this.dependencies.length;b++)if(a==this.dependencies[b])return!0;return!1}function h(a,b){var c,d=[];for(c=0;c<a.length;c++)this.checkDependency(a[c])||(this.dependencies.push(a[c]),console.log(a[c]),this.scene.data.library[a[c]]?i(this.scene.data.library[a[c]]):d.push({fn:j,vars:[a[c]]}));d.length?(d.push({fn:b}),this.arrayExecuter.execute(d)):b()}function i(a){var b=document.createElement("script");b.type="text/javascript",b.innerHTML=a,document.getElementsByTagName("head")[0].appendChild(b)}function j(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a.replace("~/",this.scene.dirPath),console.log("add_script: "+a);var d=function(){console.log("add script: loaded"),b(a)};if("undefined"!=typeof c.addEventListener)c.addEventListener("load",d,!1);else{var e=function(){"loaded"==c.readyState&&d(a)};c.attachEvent("onreadystatechange",e)}document.getElementsByTagName("head")[0].appendChild(c)}function k(a,b){console.log("/////////////////  createGLPrograms  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createGLProgram,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function l(){this.arrayExecuter.destroy(),this.scene=null,this.arrayExecuter=null,this.dependencies=null}b.prototype.loadData=c,b.prototype.checkDependency=g,b.prototype.loadDependencies=h,b.prototype.buildData=d,b.prototype.destroy=l,Aero=Aero||{},Aero.IO=b}(window),function(a){"use strict";function b(a){console.log("dataReady");var b=this.data;b.settings.dirPath&&(this.dirPath=b.settings.dirPath),this.data.library=this.data.library||{};var c=this.data.settings.preserveDrawingBuffer&&"true"==String(this.data.settings.preserveDrawingBuffer).toLowerCase()?!0:!1;this.gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:c})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:c}),this.renderer.init(),this.io.buildData(this.data,a)}function c(a){this.renderer.update(a)}function d(){this.renderer.setSize(this.data.settings.dimensions.width,this.data.settings.dimensions.height),this.data.settings.autoRender&&this.renderer.start(),this.onReady&&this.onReady()}function e(a){return this.nodes.hasOwnProperty(a)?(console.log('ERROR: cannot have more than one node with id "'+a+'"'),!1):!0}function f(a,b,c){if(this.checkNodeId(a)){var d=this.renderer.createTexture(b);this.nodes[a]=d,d.id=a,d.loadTexture(c)}}function g(a,b,c){if(this.checkNodeId(a)){if(b.dependencies&&b.dependencies.length){for(var d=!1,e=0;e<b.dependencies.length;e++)this.io.checkDependency(b.dependencies[e])||(d=!0);if(d)return void this.io.loadDependencies(b.dependencies,function(){this.createJSProgram(a,b,c)}.bind(this))}var f=new Aero.JSPrograms[b.id](b,this);this.nodes[a]=f,f.id=a,f.type="JSProgram",f.dependents=[],f.init?f.init(c):c(),f.run||(f.run=function(){})}}function h(a,b,c){if(this.checkNodeId(a)){var d=new Aero.GLProgram(b,this);this.nodes[a]=d,d.id=a,d.dependents=[],d.init(c)}}function i(){for(var a in this.nodes)this.nodes[a].destroy&&this.nodes[a].destroy();this.nodes=null,this.arrayExecuter.destroy(),this.renderer.destroy(),this.io.destroy(),this.arrayExecuter=null,this.renderer=null,this.io=null,this.onReady=null,this.canvas=null,this.data=null,this.gl=null}var j=function(a,e){console.log("Scene"),console.log(a),e&&e.canvas?this.canvas=e.canvas:this.canvas=document.createElement("canvas"),this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.renderer=new Aero.Renderer(this),this.io=new Aero.IO(this),this.onReady=e&&e.onReady?e.onReady:null,this.nodes={};var f=[{fn:this.io.loadData,scope:this.io,vars:[a]},{fn:b},{fn:c},{fn:d}];this.arrayExecuter.execute(f)};j.prototype.checkNodeId=e,j.prototype.createTexture=f,j.prototype.createJSProgram=g,j.prototype.createGLProgram=h,j.prototype.destroy=i,j.prototype.render=function(){this.renderer.render()},Aero=Aero||{},Aero.Scene=j}(window);
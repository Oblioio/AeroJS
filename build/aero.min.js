/* AeroJS v0.0.1 - http://oblio.io - @oblioio - (c) 2015 Oblio */
window.Aero=window.Aero||{},Aero.utils=Aero.utils||{},Aero.JSPrograms=Aero.JSPrograms||{},Aero.registerJSProgram=function(a,b){console.log("Aero.registerJSProgram: "+a),console.log("Aero.registerJSProgram2: "+a),Aero.JSPrograms[a]=b},function(a){function b(a){for(var b in a)a.hasOwnProperty(b)&&(a[b]=null);a=null}var c=function(a,b){this.task_arr=[],this.defaultScope=a||this,this.id=b||"",this.verbose=!1};c.prototype={execute:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | execute"),this.addNext(a),this.runStep("")},addNext:function(a){if(this.verbose&&console.log("ArrayExecuter | "+this.id+" | addNext"),"function"==typeof a)this.task_arr.unshift({fn:a,vars:null});else{a.reverse();for(var b=0;b<a.length;b++)a[b]&&this.task_arr.unshift(a[b])}},tackOn:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | tackOn");for(var b=0;b<a.length;b++)this.task_arr.push(a[b]);this.runStep("")},runFunctionInScope:function(a){var b=a[0],c=a[1];a.length>2?a[2]:null;a.length>2?b[c](a[2]):b[c]()},runStep:function(a){if(this.verbose&&console.log("ArrayExecuter | "+this.id+" | runStep"),0!=this.task_arr.length){var c=this.task_arr.shift(),d=c.fn;c.scope=c.scope||this.defaultScope,c.vars=c.vars||[],"string"==typeof c.vars&&(c.vars=[c.vars]),c.vars.push(this.stepComplete.bind(this)),d.apply(c.scope,c.vars),b(c)}},stepComplete:function(b){this.verbose&&console.log("ArrayExecuter | "+this.id+" | stepComplete"),this.task_arr.length>0&&a.requestAnimationFrame(this.runStep.bind(this))},stepComplete_instant:function(a){this.verbose&&console.log("ArrayExecuter | "+this.id+" | stepComplete_instant"),this.task_arr.length>0&&this.runStep()},clearArrayExecuter:function(){this.verbose&&console.log("ArrayExecuter | "+this.id+" | clearArrayExecuter"),this.task_arr=[]},destroy:function(){for(var a=0;a<this.task_arr.length;a++)b(this.task_arr[a]);this.task_arr=[],this.defaultScope=null}},Aero.utils.ArrayExecuter=c}(window),function(a){var b=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState)if(200==c.status||0==c.status)try{b(c.responseText)}catch(d){console.error(d)}else console.error("Couldn't load ["+a+"] ["+c.status+"]")},c.open("GET",a,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.setRequestHeader("Content-Type","text/plain"),c.send(null)};Aero.utils.XHRLoader=b}(window),function(a){"use strict";function b(a){return[1,0,0,0,0,Math.cos(a),Math.sin(a),0,0,-Math.sin(a),Math.cos(a),0,0,0,0,1]}function c(a,b){var c=Math.cos(b),d=Math.sin(b);return[a[0],a[1],a[2],a[3],a[4]*c+a[8]*d,a[5]*c+a[9]*d,a[6]*c+a[10]*d,a[7]*c+a[11]*d,a[4]*-d+a[8]*c,a[5]*-d+a[9]*c,a[6]*-d+a[10]*c,a[7]*-d+a[11]*c,a[12],a[13],a[14],a[15]]}function d(a){return[Math.cos(a),0,-Math.sin(a),0,0,1,0,0,Math.sin(a),0,Math.cos(a),0,0,0,0,1]}function e(a,b){var c=Math.cos(b),d=Math.sin(b);return[a[0]*c+a[8]*-d,a[1]*c+a[9]*-d,a[2]*c+a[10]*-d,a[3]*c+a[11]*-d,a[4],a[5],a[6],a[7],a[0]*d+a[8]*c,a[1]*d+a[9]*c,a[2]*d+a[10]*c,a[3]*d+a[11]*c,a[12],a[13],a[14],a[15]]}function f(a){return[Math.cos(a),Math.sin(a),0,0,-Math.sin(a),Math.cos(a),0,0,0,0,1,0,0,0,0,1]}function g(a,b){var c=Math.cos(b),d=Math.sin(b);return[a[0]*c+a[4]*d,a[1]*c+a[5]*d,a[2]*c+a[6]*d,a[3]*c+a[7]*d,a[0]*-d+a[4]*c,a[1]*-d+a[5]*c,a[2]*-d+a[6]*c,a[3]*-d+a[7]*c,a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]}function h(a){return[a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1]}function i(a,b){return[a[0]*b,a[1]*b,a[2]*b,a[3]*b,a[4]*b,a[5]*b,a[6]*b,a[7]*b,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]}function j(a,b,c){return[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1]}function k(a,b,c,d){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*b+a[4]*c+a[8]*d+a[12],a[1]*b+a[5]*c+a[9]*d+a[13],a[2]*b+a[6]*c+a[10]*d+a[14],a[3]*b+a[7]*c+a[11]*d+a[15]]}function l(a,b,c,d){var e=a*Math.tan(.5*c),f=-e,g=f*d,h=e*d,i=2*a/(h-g),j=2*a/(e-f),k=(h+g)/(h-g),l=(e+f)/(e-f),m=-(b+a)/(b-a),n=-2*b*a/(b-a),o=[];return o[0]=i,o[4]=0,o[8]=k,o[12]=0,o[1]=0,o[5]=j,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=m,o[14]=n,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,o}function m(a,b){return[a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7],a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7],a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7],a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7],a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11],a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11],a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11],a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11],a[0]*b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*b[15],a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15],a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15],a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15]]}function n(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]}function o(a){var b=[],c=a[0],d=a[4],e=a[8],f=a[12],g=a[1],h=a[5],j=a[9],k=a[13],l=a[2],m=a[6],n=a[10],o=a[14],p=a[3],q=a[7],r=a[11],s=a[15];b[0]=j*o*q-k*n*q+k*m*r-h*o*r-j*m*s+h*n*s,b[4]=f*n*q-e*o*q-f*m*r+d*o*r+e*m*s-d*n*s,b[8]=e*k*q-f*j*q+f*h*r-d*k*r-e*h*s+d*j*s,b[12]=f*j*m-e*k*m-f*h*n+d*k*n+e*h*o-d*j*o,b[1]=k*n*p-j*o*p-k*l*r+g*o*r+j*l*s-g*n*s,b[5]=e*o*p-f*n*p+f*l*r-c*o*r-e*l*s+c*n*s,b[9]=f*j*p-e*k*p-f*g*r+c*k*r+e*g*s-c*j*s,b[13]=e*k*l-f*j*l+f*g*n-c*k*n-e*g*o+c*j*o,b[2]=h*o*p-k*m*p+k*l*q-g*o*q-h*l*s+g*m*s,b[6]=f*m*p-d*o*p-f*l*q+c*o*q+d*l*s-c*m*s,b[10]=d*k*p-f*h*p+f*g*q-c*k*q-d*g*s+c*h*s,b[14]=f*h*l-d*k*l-f*g*m+c*k*m+d*g*o-c*h*o,b[3]=j*m*p-h*n*p-j*l*q+g*n*q+h*l*r-g*m*r,b[7]=d*n*p-e*m*p+e*l*q-c*n*q-d*l*r+c*m*r,b[11]=e*h*p-d*j*p-e*g*q+c*j*q+d*g*r-c*h*r,b[15]=d*j*l-e*h*l+e*g*m-c*j*m-d*g*n+c*h*n;var t=c*b[0]+g*b[4]+l*b[8]+p*b[12];return 0==t?[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]:b=i(b,1/t)}function p(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]}Aero.Math=Aero.Math||{},Aero.Math.Matrix4={createRotateX:b,rotateX:c,createRotateY:d,rotateY:e,createRotateZ:f,rotateZ:g,createScale:h,scale:i,createTranslation:j,translate:k,createProjection:l,multiply:m,transpose:n,inverse:o,clone:p}}(window),function(a){"use strict";function b(a){var b=[{fn:c,vars:"vShader"},{fn:c,vars:"fShader"},{fn:d},{fn:a}];this.arrayExecuter.execute(b)}function c(a,b){console.log("loadShader: "+this[a].path),this.scene.data.library[this[a].path]?(this[a].text=this.scene.data.library[this[a].path],b()):Aero.utils.XHRLoader(String(this[a].path).replace("~/",this.scene.dirPath),function(c){this[a].text=c,b()}.bind(this))}function d(a){console.log("compile program");for(var b=this.gl,c="",d="",e=0;e<this.settings.defines.length;e++)c+="#define "+this.settings.defines[e]+"\n";for(var f in this.settings.constants)d+="const "+this.settings.constants[f].type+" "+f+" = "+this.settings.constants[f].value+";\n";var g=b.createShader(b.FRAGMENT_SHADER);if(b.shaderSource(g,c+d+this.fShader.text),b.compileShader(g),o.call(this,b,"2d-fragment-shader",g)){this.fShader.obj=g;var h=b.createShader(b.VERTEX_SHADER);if(b.shaderSource(h,c+d+this.vShader.text),b.compileShader(h),o.call(this,b,"2d-vertex-shader",h)){this.vShader.obj=h;var i=b.createProgram();b.attachShader(i,h),b.attachShader(i,g),b.linkProgram(i),b.getProgramParameter(i,b.LINK_STATUS)||console.log("Unable to initialize the shader program."),b.useProgram(i),this.program=i,b.program=i,j.call(this,a)}}}function e(a){for(var b=0;b<this.settings.defines.length;b++)if(this.settings.defines[b]==a)return b;return-1}function f(a){!a||this.checkDefine(a)>=0||this.settings.defines.push(a)}function g(a){if(a){var b=this.checkDefine(a);0>b||this.settings.defines.splice(b,1)}}function h(a){!a.constructor!==Array&&(this.settings.defines=a)}function i(a,b,c){void 0!=a&&void 0!=b&&void 0!=c&&(this.settings.constants[a]={type:b,value:c})}function j(a){var b,c,d,e,f=this.gl,g=this.settings.uniforms;this.uniforms=[],this.inputs=this.inputs||{};for(var h in g){switch(b=g[h],c=f.getUniformLocation(this.program,h),d=b.val||null,b.type){case"f":case"1f":e=Aero.GLUploaders.uniform1f,d||(d=0);break;case"2f":e=Aero.GLUploaders.uniform2f,d||(d=[0,0]);break;case"3f":e=Aero.GLUploaders.uniform3f,d||(d=[0,0,0]);break;case"3m":e=Aero.GLUploaders.uniformMatrix3fv,d||(d=[1,0,0,0,1,0,0,0,1]);break;case"4f":e=Aero.GLUploaders.uniform4f,d||(d=[0,0,0,0]);break;case"4m":e=Aero.GLUploaders.uniformMatrix4fv,d||(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);break;case"t":e=Aero.GLUploaders.uniform1i;break;default:console.log("uniform type: "+b.type+" not yet setup"),e=!1}this.inputs[h]=this.inputs[h]||d,this.uniforms.push({id:h,type:b.type,loc:c,fn:e})}this.inputs.u_resolution||(c=f.getUniformLocation(this.program,"u_resolution"),null!==c&&(this.inputs.u_resolution=this.inputs.u_resolution||[1,1],this.uniforms.push({id:"u_resolution",type:"2f",loc:c,fn:Aero.GLUploaders.uniform2f}))),a&&a()}function k(){for(var a,b=this.gl,c=this.uniforms.length;c--;)a=this.uniforms[c],a.fn&&a.fn(b,a.loc,this.inputs[a.id])}function l(){var a=this.gl;a.useProgram(this.program),a.program=this.program,this.updateUniforms(),a.drawArrays(a[this.settings.renderMode],0,4)}function m(a,b){this.inputs.u_resolution&&2==this.inputs.u_resolution.length&&(this.inputs.u_resolution=[a,b])}function n(){var a=this.gl;a.deleteShader(this.fShader.obj),a.deleteShader(this.fShader.obj),this.fShader=null,this.vShader=null,this.program=null,this.inputs=null,this.uniforms=null,this.arrayExecuter.destroy(),this.scene=null,this.gl=null,this.arrayExecuter=null}function o(a,b,c){var d=this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS);return d||console.log("Error compiling "+b+": "+this.gl.getShaderInfoLog(c)),d}var p=function(a,b){this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.type="GLProgram",this.inRenderList=!1,this.scene=b,this.gl=this.scene.gl,this.settings={defines:[],constants:{},renderMode:"TRIANGLE_STRIP"};for(var c in a)this.settings[c]=a[c];this.drawToCanvas=!1,this.clearBuffer="true"==String(a.clearBuffer).toLowerCase()?!0:!1,this.vShader={path:this.settings.vertexShader},this.fShader={path:this.settings.fragmentShader}};p.prototype.init=b,p.prototype.compile=d,p.prototype.checkDefine=e,p.prototype.addDefine=f,p.prototype.removeDefine=g,p.prototype.setDefines=h,p.prototype.setConstant=i,p.prototype.updateUniforms=k,p.prototype.render=l,p.prototype.resize=m,p.prototype.destroy=n,Aero=Aero||{},Aero.GLProgram=p}(window),function(a){"use strict";function b(a){function b(){d++,6==d&&c.call(this)}if(this.onLoadComplete=a?a:null,this.src||(console.log("loadTexture ERROR: no image url"),this.onLoadComplete&&this.onLoadComplete(),this.onLoadComplete=null),console.log("loadTexture: "+this.src),this.cube){this.imgObj=[];for(var d=0,e=0;6>e;e++){var f=new Image;f.onload=b.bind(this),f.src=this.src[e].replace("~/",this.scene.dirPath),this.imgObj.push(f)}}else this.imgObj=new Image,this.imgObj.onload=c.bind(this),this.imgObj.src=this.src.replace("~/",this.scene.dirPath)}function c(){var a=this.scene.gl,b=this.texture;if(a.activeTexture(a["TEXTURE"+this.texUnit]),a.bindTexture(this.type,b),this.width=this.imgObj.width,this.height=this.imgObj.height,a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texParameteri(this.type,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(this.type,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(this.type,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(this.type,a.TEXTURE_MIN_FILTER,a.LINEAR),this.cube)for(var c=0;6>c;c++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.imgObj[c]);else a.texImage2D(this.type,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.imgObj);this.onLoadComplete&&(this.onLoadComplete(),this.onLoadComplete=null)}function d(){var a=this.scene.gl,b=this.texture;a.deleteTexture(b),this.imgObj=null,this.texture=null,this.scene=null,this.settings=null,this.src=null,this.texUnit=null}var e=function(a,b){var c=b.gl;this.type="texture",this.inRenderList=!1,this.scene=b,this.settings=a,this.src=a.src?a.src:null,this.cube=a.src&&a.src.constructor===Array?!0:!1,this.type=this.cube?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D,this.texUnit=a.texUnit,console.log("GLTexture Init: "+this.texUnit),this.texture=c.createTexture()};e.prototype.loadTexture=b,e.prototype.destroy=d,Aero=Aero||{},Aero.GLTexture=e}(window),function(a){"use strict";Aero=Aero||{},Aero.GLUploaders={uniform1f:function(a,b,c){a.uniform1f(b,c)},uniform2f:function(a,b,c){a.uniform2f(b,c[0],c[1])},uniform3f:function(a,b,c){a.uniform3f(b,c[0],c[1],c[2])},uniform4f:function(a,b,c){a.uniform4f(b,c[0],c[1],c[2],c[3])},uniform1i:function(a,b,c){a.uniform1i(b,c)},uniform2i:function(a,b,c){a.uniform2i(b,c)},uniform3i:function(a,b,c){a.uniform3i(b,c)},uniform4i:function(a,b,c){a.uniform3i(b,c)},uniformMatrix2fv:function(a,b,c){a.uniformMatrix2fv(b,a.FALSE,c)},uniformMatrix3fv:function(a,b,c){a.uniformMatrix3fv(b,a.FALSE,c)},uniformMatrix4fv:function(a,b,c){a.uniformMatrix4fv(b,a.FALSE,c)}}}(window),function(a){"use strict";function b(a){this.scene=a,this.frameBuffers=[]}function c(){this.gl=this.scene.gl,this.maxTextureUnits=this.scene.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.nextTexUnit=0,this.autoRender=!1,this.arrayExecuter=new Aero.utils.ArrayExecuter(this)}function d(a){var b=[{fn:n},{fn:a}];this.arrayExecuter.execute(b)}function e(a,b){console.log("setSize: "+a+", "+b),this.scene.canvas.width=a,this.scene.canvas.height=b,this.gl.viewport(0,0,Number(a),Number(b));var c=this.scene.nodes;for(var d in c)c[d].resize&&c[d].resize(a,b);for(var e=this.gl,f=0;f<this.frameBuffers.length;f++)"auto"===this.frameBuffers[f].size&&(this.frameBuffers[f].width=a,this.frameBuffers[f].height=b,e.activeTexture(e["TEXTURE"+this.frameBuffers[f].texUnit]),e.bindTexture(e.TEXTURE_2D,this.frameBuffers[f].texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,b,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,this.frameBuffers[f].renderBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a,b),e.bindRenderbuffer(e.RENDERBUFFER,null));this.scene.needsUpdate=!0}function f(a){console.log("/////////////////  createRenderList  /////////////////");var b,c,d,e,f,i,k,l,m,n,o,p=(this.scene.connections,this.scene.connectionSearch("dest","canvas"));this.renderList=[];for(c in this.scene.nodes)this.scene.nodes[c].inRenderList=!1,this.scene.nodes[c].dependents=[];for(o=0;o<p.length;o++)f=g.call(this,p[o],"source"),f.drawToCanvas=!0;for(;p.length;)if(b=p.shift(),k=l=!1,c=g.call(this,b,"source"),!c.inRenderList){for(c.inRenderList=!0,d=this.scene.connectionSearch("source",b.source.id),m=0;m<d.length;m++)f=g.call(this,d[m],"dest"),f&&("texture"==c.type&&(f.inputs[d[m].dest["var"]]=c.texUnit),"GLProgram"==c.type&&c.dependents.push({id:f.id,destVar:d[m].dest["var"]}),"JSProgram"==c.type&&(console.log("add output to JSProgram"),c.dependents.push({obj:f,id:f.id,sourceVar:d[m].source["var"],destVar:d[m].dest["var"]})),i=h(this.renderList,f),d[m].feedback&&"true"==String(d[m].feedback).toLowerCase()||i!==!1&&(l=l!==!1?Math.min(i,l):i));for(e=this.scene.connectionSearch("dest",b.source.id),n=0;n<e.length;n++)f=g.call(this,e[n],"source"),f&&(f.inRenderList||p.unshift(e[n]),i=h(this.renderList,f),e[n].feedback&&"true"==String(e[n].feedback).toLowerCase()||i!==!1&&(k=k!==!1?Math.max(i,k):i));if(k!==!1&&l!==!1&&k>=l)return void console.log("createRenderList: FEEDBACK LOOP! lowestIndex is greater than highestIndex");l!==!1?this.renderList.splice(l,0,c):k!==!1?this.renderList.splice(k+1,0,c):this.renderList.push(c)}for(var q="RENDER ORDER: ",o=0;o<this.renderList.length;o++)q+=this.renderList[o].id+" > ";console.log(q),j.call(this,a)}function g(a,b){var c=!1,d=!1;return(c=this.scene.nodes)?(d=c[a[b].id],d?d:(console.log('getConnectedNode: node id "'+a[b].id+'" returned no results'),!1)):(console.log("getConnectedNode: node type "+a[b].type+" returned no results"),!1)}function h(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return!1}function i(a){return a=a||{},a.texUnit=this.getNextTexUnit(),new Aero.GLTexture(a,this.scene)}function j(a){console.log("/////////////////  assignFrameBuffers  /////////////////");for(var b=0;b<this.frameBuffers.length;b++)this.frameBuffers[b].holdForever=!1,this.frameBuffers[b].holdIndex=-1;for(var c,d,e,f,g,i,b=0;b<this.scene.renderTargets.length;b++){var j=this.scene.renderTargets[b];if(j.nodes.length)for(c=this.frameBuffers[b]||k.call(this,0),c.holdForever=!0,i=0;i<j.nodes.length;i++)d=this.scene.nodes[j.nodes[i]],d?d.forcedBuffer=c:console.log('Could not assign frame buffer "'+g+'" to node "'+j.nodes[i]+'" because it does not exist')}for(g=0;g<this.renderList.length;g++)if(d=this.renderList[g],"texture"!=d.type&&("JSProgram"!=d.type||d.draws)&&!d.drawToCanvas&&d.dependents&&d.dependents.length){for(d.forcedBuffer?(c=d.forcedBuffer,d.forcedBuffer=null):c=k.call(this,g),d.outputs=d.outputs||{},d.outputs.texUnit=c.texUnit,i=0;i<d.dependents.length;i++)e=this.scene.nodes[d.dependents[i].id],"GLProgram"==e.type&&(e.inputs[d.dependents[i].destVar]=c.texUnit),f=h(this.renderList,e),c.holdIndex=Math.max(f,c.holdIndex);d.outputBuffer=c.index}a()}function k(a){for(var b=0;b<this.frameBuffers.length;b++)if(!this.frameBuffers[b].holdForever&&this.frameBuffers[b].holdIndex<a)return this.frameBuffers[b];var c=l.call(this);return c.index=this.frameBuffers.length,c.holdIndex=0,this.frameBuffers.push(c),c}function l(){var a=this.gl,b=a.createFramebuffer(),c=a.createTexture(),d=a.createRenderbuffer(),e="auto",f=this.scene.canvas.width,g=this.scene.canvas.height,h=this.getNextTexUnit();return console.log("createFrameBuffer: texUnit "+h),a.activeTexture(a["TEXTURE"+h]),a.bindFramebuffer(a.FRAMEBUFFER,b),a.bindTexture(a.TEXTURE_2D,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,f,g,0,a.RGBA,a.UNSIGNED_BYTE,null),a.bindRenderbuffer(a.RENDERBUFFER,d),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,f,g),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,d),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),{size:e,frameBuffer:b,texture:c,renderBuffer:d,width:f,height:g,texUnit:h}}function m(){var a=this.nextTexUnit;return a>=this.maxTextureUnits&&console.log("ERROR: TexUnit "+a+" | Only "+this.maxTextureUnits+" are supported."),this.nextTexUnit++,a}function n(a){console.log("initVertexBuffers");var b=this.gl,c=new Float32Array([-1,1,0,1,-1,-1,0,0,1,1,1,1,1,-1,1,0]),d=b.createBuffer();return d?(b.bindBuffer(b.ARRAY_BUFFER,d),b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW),this.standardVertexBuffer={buffer:d,array:c,fsize:c.BYTES_PER_ELEMENT},this.usingStandardVertexBuffer=!1,void a()):(console.log("Failed to create the buffer object"),-1)}function o(){var a=this.gl;this.usingStandardVertexBuffer=!0,a.bindBuffer(a.ARRAY_BUFFER,this.standardVertexBuffer.buffer),p(a,"a_Position",this.standardVertexBuffer.fsize,2,4,0),p(a,"a_TexCoord",this.standardVertexBuffer.fsize,2,4,2)}function p(a,b,c,d,e,f){var g=a.getAttribLocation(a.program,b);return 0>g?(console.log("Failed to get the attribute storage location of "+b),!1):(a.vertexAttribPointer(g,d,a.FLOAT,!1,c*e,c*f),a.enableVertexAttribArray(g),!0)}function q(a,b){var c=this.gl;this.usingStandardVertexBuffer=!1;var d=c.createBuffer();return d?(c.bindBuffer(a.type||c.ARRAY_BUFFER,d),c.bufferData(a.type||c.ARRAY_BUFFER,a,c.DYNAMIC_DRAW),{buffer:d,type:a.type||c.ARRAY_BUFFER,length:a.length,data:a,fsize:a.BYTES_PER_ELEMENT,attributes:b}):(console.log("Failed to create the buffer object"),-1)}function r(a){var b=this.gl;this.usingStandardVertexBuffer=!1,b.bindBuffer(a.type,a.buffer),a.data.length>a.length?(a.length=a.data.length,b.bufferData(a.type,a.data,b.DYNAMIC_DRAW)):b.bufferSubData(a.type,0,a.data)}function s(a){var b=this.gl;this.usingStandardVertexBuffer=!1,b.bindBuffer(a.type,a.buffer);for(var c=a.attributes.length;c--;)p(b,a.attributes[c].id,a.fsize,a.attributes[c].num,a.attributes[c].stride,a.attributes[c].start)}function t(){this.autoRender||(this.autoRender=!0,this.render())}function u(){this.autoRender=!1}function v(){var b,c,d=this.gl;if(this.gl){if(this.scene.needsUpdate)return this.scene.needsUpdate=!1,void f.call(this,function(){console.log("render list callback"),v.call(this)}.bind(this));for(var e=0;e<this.renderList.length;e++)switch(b=this.renderList[e],b.type){case"GLProgram":b.drawToCanvas?d.bindFramebuffer(d.FRAMEBUFFER,null):(d.bindFramebuffer(d.FRAMEBUFFER,this.frameBuffers[b.outputBuffer].frameBuffer),b.clearBuffer&&d.clear(d.COLOR_BUFFER_BIT)),d.useProgram(b.program),d.program=b.program,this.usingStandardVertexBuffer||this.useStandardVertexBuffer(this),b.updateUniforms(),b.render();break;case"JSProgram":for(b.draws&&(b.drawToCanvas?d.bindFramebuffer(d.FRAMEBUFFER,null):(d.bindFramebuffer(d.FRAMEBUFFER,this.frameBuffers[b.outputBuffer].frameBuffer),b.clearBuffer&&d.clear(d.COLOR_BUFFER_BIT))),b.run(),c=b.dependents.length;c--;)b.dependents[c].obj.inputs[b.dependents[c].destVar]=b.outputs[b.dependents[c].sourceVar];break;case"texture":}this.autoRender&&a.requestAnimationFrame(v.bind(this))}}function w(){for(var a=this.scene.gl,b=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),c=0;b>c;++c)a.activeTexture(a.TEXTURE0+c),a.bindTexture(a.TEXTURE_2D,null),a.bindTexture(a.TEXTURE_CUBE_MAP,null);a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null);for(var d=0;d<this.frameBuffers.length;d++)a.deleteRenderbuffer(this.frameBuffers[d].renderBuffer),a.deleteFramebuffer(this.frameBuffers[d].frameBuffer),a.deleteTexture(this.frameBuffers[d].texture),this.frameBuffers[d]=null;this.arrayExecuter.destroy(),this.scene=null,this.gl=null,this.arrayExecuter=null,this.renderList=null,this.frameBuffers=null}b.prototype.init=c,b.prototype.update=d,b.prototype.setSize=e,b.prototype.start=t,b.prototype.pause=u,b.prototype.render=v,b.prototype.createTexture=i,b.prototype.getNextTexUnit=m,b.prototype.useStandardVertexBuffer=o,b.prototype.useCustomBuffer=s,b.prototype.createCustomBuffer=q,b.prototype.updateCustomBuffer=r,b.prototype.destroy=w,Aero=Aero||{},Aero.Renderer=b}(window),function(a){"use strict";function b(a){this.scene=a,this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.dependencies=[]}function c(a,b){console.log("AERO: loadData"),"string"==typeof a?Aero.utils.XHRLoader(a,function(c){this.scene.dirPath=a.indexOf("/")>=0?a.substring(0,a.lastIndexOf("/")+1):"",this.scene.data=JSON.parse(c),b()}.bind(this)):(this.scene.dirPath="",this.scene.data=a,b())}function d(a,b){console.log("AERO: buildData");var c=[{fn:e,vars:[a.textures]},{fn:f,vars:[a.jsPrograms||a.JSPrograms]},{fn:k,vars:[a.glPrograms||a.GLPrograms]},{fn:m,vars:[a.renderTargets||a.Connections]},{fn:l,vars:[a.connections||a.Connections]},{fn:b}];this.arrayExecuter.execute(c)}function e(a,b){console.log("/////////////////  createTextures  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createTexture,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function f(a,b){console.log("/////////////////  createJSPrograms  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createJSProgram,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function g(a){for(var b=0;b<this.dependencies.length;b++)if(a==this.dependencies[b])return!0;return!1}function h(a,b){var c,d=[];for(c=0;c<a.length;c++)this.checkDependency(a[c])||(this.dependencies.push(a[c]),console.log(a[c]),this.scene.data.library[a[c]]?i(this.scene.data.library[a[c]]):d.push({fn:j,vars:[a[c]]}));d.length?(d.push({fn:b}),this.arrayExecuter.execute(d)):b()}function i(a){var b=document.createElement("script");b.type="text/javascript",b.innerHTML=a,document.getElementsByTagName("head")[0].appendChild(b)}function j(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a.replace("~/",this.scene.dirPath),console.log("add_script: "+a);var d=function(){console.log("add script: loaded"),b(a)};if("undefined"!=typeof c.addEventListener)c.addEventListener("load",d,!1);else{var e=function(){"loaded"==c.readyState&&d(a)};c.attachEvent("onreadystatechange",e)}document.getElementsByTagName("head")[0].appendChild(c)}function k(a,b){console.log("/////////////////  createGLPrograms  /////////////////");var c=[];for(var d in a)c.push({fn:this.scene.createGLProgram,scope:this.scene,vars:[d,a[d]]});c.length?(c.push({fn:b}),this.arrayExecuter.execute(c)):b()}function l(a,b){for(var c=0;c<a.length;c++)this.scene.createConnection(a[c].source.id,a[c].source["var"]||null,a[c].dest.id,a[c].dest["var"]||null,a[c].feedback||null);b&&b()}function m(a,b){for(var c in a)this.scene.createRenderTarget(c,a[c].nodes||[]);b&&b()}function n(){this.arrayExecuter.destroy(),this.scene=null,this.arrayExecuter=null,this.dependencies=null}b.prototype.loadData=c,b.prototype.checkDependency=g,b.prototype.loadDependencies=h,b.prototype.buildData=d,b.prototype.destroy=n,Aero=Aero||{},Aero.IO=b}(window),function(a){"use strict";function b(a){console.log("dataReady");var b=this.data;b.settings.dirPath&&(this.dirPath=b.settings.dirPath),this.data.library=this.data.library||{};var c=this.data.settings.preserveDrawingBuffer&&"true"==String(this.data.settings.preserveDrawingBuffer).toLowerCase()?!0:!1;this.gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:c})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:c}),this.renderer.init(),this.io.buildData(this.data,a)}function c(a){this.renderer.update(a)}function d(){this.renderer.setSize(this.data.settings.dimensions.width,this.data.settings.dimensions.height),this.data.settings.autoRender&&this.renderer.start(),this.ready=!0,this.onReady&&this.onReady()}function e(a){return this.nodes.hasOwnProperty(a)?(console.log('ERROR: cannot have more than one node with id "'+a+'"'),!1):!0}function f(a,b,c){if(this.checkNodeId(a)){var d=this.renderer.createTexture(b);this.nodes[a]=d,d.id=a,d.loadTexture(c)}}function g(a,b,c){if(this.checkNodeId(a)){if(b.dependencies&&b.dependencies.length){for(var d=!1,e=0;e<b.dependencies.length;e++)this.io.checkDependency(b.dependencies[e])||(d=!0);if(d)return void this.io.loadDependencies(b.dependencies,function(){this.createJSProgram(a,b,c)}.bind(this))}var f=new Aero.JSPrograms[b.id](b,this);this.nodes[a]=f,f.id=a,f.type="JSProgram",f.dependents=[],f.init?f.init(c):c(),f.run||(f.run=function(){})}}function h(a,b,c){if(this.checkNodeId(a)){var d=new Aero.GLProgram(b,this);this.nodes[a]=d,d.id=a,d.dependents=[],d.init(c)}}function i(a,b){for(var c=[],d=0;d<b.length;d++)this.nodes.hasOwnProperty(b[d])&&c.push(b[d]);this.renderTargets.push({id:a,nodes:c})}function j(a,b,c,d,e){a&&c&&this.nodes.hasOwnProperty(a)&&(this.nodes.hasOwnProperty(c)||"canvas"==String(c).toLowerCase())&&(this.connections.push({id:this._idCount++,feedback:e||!1,source:{id:a,"var":b},dest:{id:c,"var":d}}),this.needsUpdate=!0)}function k(a){for(var b=0;b<this.connections.length;b++)if(this.connections[b].id==a)return b;return-1}function l(a,b,c,d){var e=k.call(this,a);if(e>=0&&(this.nodes.hasOwnProperty(c)||"canvas"==String(c).toLowerCase()&&"source"==b)){var f=this.connections[e];f[b].id=c,f[b]["var"]=d||null,this.needsUpdate=!0}}function m(a,b,c){for(var d=[],c=c||this.connections,e=0;e<c.length;e++)c[e][a].id.toLowerCase()==String(b).toLowerCase()&&d.push(c[e]);return d}function n(){for(var a in this.nodes)this.nodes[a].destroy&&this.nodes[a].destroy();this.nodes=null,this.arrayExecuter.destroy(),this.renderer.destroy(),this.io.destroy(),this.arrayExecuter=null,this.renderer=null,this.io=null,this.onReady=null,this.canvas=null,this.data=null,this.gl=null}var o=function(a,e){console.log("Scene"),console.log(a),e&&e.canvas?this.canvas=e.canvas:this.canvas=document.createElement("canvas"),this.arrayExecuter=new Aero.utils.ArrayExecuter(this),this.renderer=new Aero.Renderer(this),this.io=new Aero.IO(this),this.ready=!1,this.onReady=e&&e.onReady?e.onReady:null,this.nodes={},this.connections=[],this.renderTargets=[],this.needsUpdate=!1,this._idCount=0;var f=[{fn:this.io.loadData,scope:this.io,vars:[a]},{fn:b},{fn:c},{fn:d}];this.arrayExecuter.execute(f)};o.prototype.checkNodeId=e,o.prototype.createTexture=f,o.prototype.createJSProgram=g,o.prototype.createGLProgram=h,o.prototype.createRenderTarget=i,o.prototype.createConnection=j,o.prototype.updateConnection=l,o.prototype.connectionSearch=m,o.prototype.destroy=n,o.prototype.render=function(){this.renderer.render()},Aero=Aero||{},Aero.Scene=o}(window);